generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id                        String                  @id @default(cuid())
  name                      String?
  email                     String?                 @unique
  emailVerified             DateTime?
  image                     String?
  role                      Role                    @default(MEMBER)
  teamId                    String?
  createdAt                 DateTime                @default(now())
  updatedAt                 DateTime                @updatedAt
  number                    Int?
  position                  String?
  phoneNumber               String?
  isEquipmentManager        Boolean                 @default(false)
  aiInsights                AIInsight[]
  accounts                  Account[]
  checkIns                  CheckIn[]
  comments                  Comment[]
  equipmentAssignments      EquipmentAssignment[]
  feedbacks                 Feedback[]
  cardsReceived             CardRecord[]            @relation("CardPlayer")
  cardsRecorded             CardRecord[]            @relation("CardRecorder")
  goalsAssisted             GoalRecord[]            @relation("GoalAssistant")
  goalsRecorded             GoalRecord[]            @relation("GoalRecorder")
  goalsScored               GoalRecord[]            @relation("GoalScorer")
  lateFees                  LateFee[]
  likes                     Like[]
  sentNotes                 LockerNote[]            @relation("SentNotes")
  receivedNotes             LockerNote[]            @relation("ReceivedNotes")
  nudgesReceived            Nudge[]                 @relation("NudgeRecipient")
  nudgesSent                Nudge[]                 @relation("NudgeSender")
  substitutionsIn           PlayerSubstitution[]    @relation("PlayerIn")
  substitutionsOut          PlayerSubstitution[]    @relation("PlayerOut")
  substitutionsRecorded     PlayerSubstitution[]    @relation("SubstitutionRecorder")
  pomVotesReceived          PomVote[]               @relation("PomNominee")
  pomVotesCast              PomVote[]               @relation("PomVoter")
  pushSubscriptions         PushSubscription[]
  quarterRefereeAssignments QuarterReferee[]
  rsvps                     Rsvp[]
  sessions                  Session[]
  sessionTeamAssignments    SessionTeamAssignment[]
  createdTeam               Team?                   @relation("CreatedBy")
  createdTrainingEvents     TrainingEvent[]         @relation("TrainingEventCreator")
  vestBringerEvents         TrainingEvent[]         @relation("VestBringer")
  vestReceiverEvents        TrainingEvent[]         @relation("VestReceiver")
  trainingEventComments     TrainingEventComment[]
  trainingLogs              TrainingLog[]
  team                      Team?                   @relation(fields: [teamId], references: [id])
  managedEquipments         Equipment[]             @relation("EquipmentManagers")
  taggedInLogs              TrainingLog[]           @relation("TaggedInLogs")

  @@index([teamId])
  @@index([teamId, isEquipmentManager])
}

model Team {
  id             String          @id @default(cuid())
  name           String
  inviteCode     String          @unique @default(cuid())
  createdAt      DateTime        @default(now())
  createdBy      String          @unique
  logoUrl        String?
  primaryColor   String          @default("#967B5D")
  vestOrder      String[]        @default([])
  eloRating      Float           @default(1000.0)
  aiInsights     AIInsight[]
  equipments     Equipment[]
  nudges         Nudge[]
  creator        User            @relation("CreatedBy", fields: [createdBy], references: [id])
  opponentEvents TrainingEvent[] @relation("OpponentTeam")
  trainingEvents TrainingEvent[]
  uniforms       Uniform[]
  members        User[]
  venues         Venue[]
}

model Uniform {
  id        String   @id @default(cuid())
  teamId    String
  name      String
  color     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, name])
  @@index([teamId])
}

model Venue {
  id               String          @id @default(cuid())
  teamId           String
  name             String
  address          String?
  surface          String?
  recommendedShoes String[]        @default([])
  usageCount       Int             @default(0)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  latitude         Float?
  longitude        Float?
  mapUrl           String?
  trainingEvents   TrainingEvent[]
  team             Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, name])
}

model TrainingLog {
  id              String         @id @default(cuid())
  userId          String
  trainingDate    DateTime
  condition       Int
  conditionReason String
  keyPoints       String
  improvement     String
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  imageUrl        String?
  title           String?
  trainingEventId String?
  notes           String?
  comments        Comment[]
  likes           Like[]
  lockerNotes     LockerNote[]   @relation("LockerNotes")
  trainingEvent   TrainingEvent? @relation(fields: [trainingEventId], references: [id])
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  taggedUsers     User[]         @relation("TaggedInLogs")

  @@index([userId, createdAt(sort: Desc)])
  @@index([trainingEventId])
}

model Comment {
  id            String      @id @default(cuid())
  content       String
  userId        String
  trainingLogId String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  mentions      String[]    @default([])
  trainingLog   TrainingLog @relation(fields: [trainingLogId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([trainingLogId, createdAt])
}

model Like {
  id            String      @id @default(cuid())
  userId        String
  trainingLogId String
  createdAt     DateTime    @default(now())
  trainingLog   TrainingLog @relation(fields: [trainingLogId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, trainingLogId])
  @@index([trainingLogId])
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
}

model Nudge {
  id          String   @id @default(cuid())
  senderId    String
  recipientId String
  teamId      String
  createdAt   DateTime @default(now())
  recipient   User     @relation("NudgeRecipient", fields: [recipientId], references: [id], onDelete: Cascade)
  sender      User     @relation("NudgeSender", fields: [senderId], references: [id], onDelete: Cascade)
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId, createdAt(sort: Desc)])
}

model TrainingEvent {
  id                       String                 @id @default(cuid())
  teamId                   String
  createdById              String
  date                     DateTime
  location                 String
  uniform                  String?
  vestBringerId            String?
  vestReceiverId           String?
  rsvpDeadline             DateTime
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt
  isRegular                Boolean                @default(true)
  title                    String
  notes                    String?
  shoes                    String[]               @default([])
  venueId                  String?
  enablePomVoting          Boolean                @default(true)
  pomVotesPerPerson        Int                    @default(1)
  pomVotingDeadline        DateTime?
  pomPushSentAt            DateTime?
  equipmentCheckPushSentAt DateTime?
  temperature              Float?
  weather                  String?
  weatherDescription       String?
  airQualityIndex          Int?
  pm10                     Float?
  pm25                     Float?
  chanceOfRain             Int?
  feelsLikeC               Float?
  precipMm                 Float?
  uvIndex                  Float?
  windKph                  Float?
  sunrise                  String?
  sunset                   String?
  maxTempC                 Float?
  minTempC                 Float?
  cancellationReason       CancellationReason?
  cancelled                Boolean                @default(false)
  convertedFromMatch       Boolean                @default(false)
  eloRatingChange          Float?
  isFriendlyMatch          Boolean                @default(false)
  linkedEventId            String?                @unique
  matchStatus              MatchStatus            @default(DRAFT)
  minimumPlayers           Int?
  opponentTeamId           String?
  rsvpDeadlineOffset       Int?
  teamAScore               Int                    @default(0)
  teamBScore               Int                    @default(0)
  opponentTeamName         String?
  challengeToken           String?                @unique
  challengeTokenExpiresAt  DateTime?
  challengeRejectionReason String?
  checkIns                 CheckIn[]
  equipmentAssignments     EquipmentAssignment[]
  cardRecords              CardRecord[]
  goalRecords              GoalRecord[]
  lateFees                 LateFee[]
  lockerNotes              LockerNote[]
  matchRules               MatchRules?
  playerSubstitutions      PlayerSubstitution[]
  pomVotes                 PomVote[]
  refereeAssignment        RefereeAssignment?
  rsvps                    Rsvp[]
  createdBy                User                   @relation("TrainingEventCreator", fields: [createdById], references: [id])
  linkedEvent              TrainingEvent?         @relation("FriendlyPair", fields: [linkedEventId], references: [id])
  linkedByEvent            TrainingEvent?         @relation("FriendlyPair")
  opponentTeam             Team?                  @relation("OpponentTeam", fields: [opponentTeamId], references: [id])
  team                     Team                   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  venue                    Venue?                 @relation(fields: [venueId], references: [id])
  vestBringer              User?                  @relation("VestBringer", fields: [vestBringerId], references: [id])
  vestReceiver             User?                  @relation("VestReceiver", fields: [vestReceiverId], references: [id])
  comments                 TrainingEventComment[]
  trainingLogs             TrainingLog[]
  sessions                 TrainingSession[]

  @@index([teamId, date(sort: Desc)])
  @@index([teamId, date(sort: Asc)], map: "TrainingEvent_teamId_date_asc_idx")   // 예정 운동 조회 (gte + orderBy asc)
  @@index([isFriendlyMatch, matchStatus])
}

model Rsvp {
  id              String        @id @default(cuid())
  trainingEventId String
  userId          String
  status          RsvpStatus
  reason          String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  trainingEvent   TrainingEvent @relation(fields: [trainingEventId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([trainingEventId, userId])
  @@index([trainingEventId])
  @@index([userId, status])
}

model CheckIn {
  id              String        @id @default(cuid())
  trainingEventId String
  userId          String
  checkedInAt     DateTime      @default(now())
  isLate          Boolean       @default(false)
  manualEntry     Boolean       @default(false)
  trainingEvent   TrainingEvent @relation(fields: [trainingEventId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([trainingEventId, userId])
  @@index([trainingEventId])
  @@index([userId])
}

model LateFee {
  id              String        @id @default(cuid())
  trainingEventId String
  userId          String
  amount          Int
  status          LateFeeStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  trainingEvent   TrainingEvent @relation(fields: [trainingEventId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([trainingEventId, userId])
  @@index([trainingEventId])
}

model TrainingSession {
  id              String                  @id @default(cuid())
  trainingEventId String
  title           String?
  memo            String?
  orderIndex      Int                     @default(0)
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  requiresTeams   Boolean                 @default(false)
  formation       String?
  positions       Json?
  sessionType     String                  @default("ALL")
  teamAssignments SessionTeamAssignment[]
  trainingEvent   TrainingEvent           @relation(fields: [trainingEventId], references: [id], onDelete: Cascade)
}

model SessionTeamAssignment {
  id                String          @id @default(cuid())
  trainingSessionId String
  userId            String
  teamLabel         String
  createdAt         DateTime        @default(now())
  trainingSession   TrainingSession @relation(fields: [trainingSessionId], references: [id], onDelete: Cascade)
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([trainingSessionId, userId])
  @@index([trainingSessionId])
}

model Equipment {
  id          String                @id @default(cuid())
  teamId      String
  name        String
  description String?
  orderIndex  Int                   @default(0)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  team        Team                  @relation(fields: [teamId], references: [id], onDelete: Cascade)
  assignments EquipmentAssignment[]
  managers    User[]                @relation("EquipmentManagers")

  @@unique([teamId, name])
}

model EquipmentAssignment {
  id              String        @id @default(cuid())
  trainingEventId String
  equipmentId     String
  userId          String?
  memo            String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  equipment       Equipment     @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  trainingEvent   TrainingEvent @relation(fields: [trainingEventId], references: [id], onDelete: Cascade)
  user            User?         @relation(fields: [userId], references: [id])

  @@unique([trainingEventId, equipmentId])
  @@index([trainingEventId])
}

model PomVote {
  id              String        @id @default(cuid())
  trainingEventId String
  voterId         String
  nomineeId       String
  reason          String
  createdAt       DateTime      @default(now())
  tags            String[]      @default([])
  nominee         User          @relation("PomNominee", fields: [nomineeId], references: [id], onDelete: Cascade)
  trainingEvent   TrainingEvent @relation(fields: [trainingEventId], references: [id], onDelete: Cascade)
  voter           User          @relation("PomVoter", fields: [voterId], references: [id], onDelete: Cascade)

  @@unique([trainingEventId, voterId, nomineeId])
  @@index([trainingEventId])
  @@index([nomineeId])
}

model MatchRules {
  id              String        @id @default(cuid())
  trainingEventId String        @unique
  template        RuleTemplate  @default(CUSTOM)
  kickoffTime     String?
  quarterCount    Int           @default(4)
  quarterMinutes  Int           @default(12)
  quarterBreak    Int           @default(2)
  halftime        Int           @default(5)
  playersPerSide  Int           @default(6)
  allowBackpass       Boolean       @default(false)
  allowOffside        Boolean       @default(false)
  quarterRefereeTeams Json?
  agreedByTeamA       Boolean       @default(false)
  agreedByTeamB   Boolean       @default(false)
  currentPhase    Int       @default(0)   // 0=시작전, 1=1Q, 2=휴식/하프타임, 3=2Q ...
  timerStartedAt  DateTime?               // null이면 정지 상태
  timerElapsedSec Int       @default(0)   // 정지 시점까지 누적 초
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  trainingEvent   TrainingEvent @relation(fields: [trainingEventId], references: [id], onDelete: Cascade)

  @@index([trainingEventId])
}

model RefereeAssignment {
  id              String           @id @default(cuid())
  trainingEventId String           @unique
  status          AssignmentStatus @default(DRAFT)
  approvedByTeamA Boolean          @default(false)
  approvedByTeamB Boolean          @default(false)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  quarterReferees QuarterReferee[]
  trainingEvent   TrainingEvent    @relation(fields: [trainingEventId], references: [id], onDelete: Cascade)

  @@index([trainingEventId])
}

model QuarterReferee {
  id             String            @id @default(cuid())
  assignmentId   String
  quarter        Int
  userId         String
  startedAt      DateTime?
  endedAt        DateTime?
  createdAt      DateTime          @default(now())
  teamSide       TeamSide
  elapsedSeconds Int               @default(0)
  lastResumedAt  DateTime?
  timerStatus    TimerStatus       @default(IDLE)
  assignment     RefereeAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, quarter])
  @@index([assignmentId])
  @@index([userId])
}

model GoalRecord {
  id              String        @id @default(cuid())
  trainingEventId String
  quarter         Int
  scorerId        String?
  assistId        String?
  recordedById    String
  minute          Int?
  isOwnGoal       Boolean       @default(false)
  createdAt       DateTime      @default(now())
  scoringTeam     TeamSide
  assistant       User?         @relation("GoalAssistant", fields: [assistId], references: [id])
  recordedBy      User          @relation("GoalRecorder", fields: [recordedById], references: [id], onDelete: Cascade)
  scorer          User?         @relation("GoalScorer", fields: [scorerId], references: [id])
  trainingEvent   TrainingEvent @relation(fields: [trainingEventId], references: [id], onDelete: Cascade)

  @@index([trainingEventId, quarter])
}

model PlayerSubstitution {
  id              String        @id @default(cuid())
  trainingEventId String
  quarter         Int
  playerOutId     String?
  playerInId      String?
  recordedById    String
  minute          Int?
  createdAt       DateTime      @default(now())
  teamSide        TeamSide
  playerIn        User?         @relation("PlayerIn", fields: [playerInId], references: [id], onDelete: SetNull)
  playerOut       User?         @relation("PlayerOut", fields: [playerOutId], references: [id], onDelete: SetNull)
  recordedBy      User          @relation("SubstitutionRecorder", fields: [recordedById], references: [id], onDelete: Cascade)
  trainingEvent   TrainingEvent @relation(fields: [trainingEventId], references: [id], onDelete: Cascade)

  @@index([trainingEventId, quarter])
  @@index([playerOutId])
  @@index([playerInId])
}

model LockerNote {
  id              String         @id @default(cuid())
  content         String
  color           String
  rotation        Float          @default(0)
  positionX       Float          @default(0)
  positionY       Float          @default(0)
  isAnonymous     Boolean        @default(false)
  authorId        String
  recipientId     String
  trainingEventId String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  tags            String[]
  trainingLogId   String?
  author          User           @relation("SentNotes", fields: [authorId], references: [id], onDelete: Cascade)
  recipient       User           @relation("ReceivedNotes", fields: [recipientId], references: [id], onDelete: Cascade)
  trainingEvent   TrainingEvent? @relation(fields: [trainingEventId], references: [id])
  trainingLog     TrainingLog?   @relation("LockerNotes", fields: [trainingLogId], references: [id])

  @@index([recipientId, createdAt(sort: Desc)])
  @@index([authorId])
  @@index([trainingLogId])
}

model Feedback {
  id        String         @id @default(cuid())
  type      FeedbackType
  title     String
  content   String
  status    FeedbackStatus @default(NEW)
  userId    String?
  userEmail String?
  userName  String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  user      User?          @relation(fields: [userId], references: [id])

  @@index([status, createdAt(sort: Desc)])
  @@index([userId])
}

model TrainingEventComment {
  id              String        @id @default(cuid())
  content         String
  authorId        String
  trainingEventId String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  author          User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  trainingEvent   TrainingEvent @relation(fields: [trainingEventId], references: [id], onDelete: Cascade)

  @@index([trainingEventId, createdAt(sort: Desc)])
  @@index([authorId])
}

model AIInsight {
  id        String      @id @default(cuid())
  type      InsightType
  content   String
  userId    String?
  teamId    String?
  dateOnly  String
  createdAt DateTime    @default(now())
  team      Team?       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User?       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dateOnly])
  @@unique([teamId, dateOnly])
  @@index([userId, createdAt(sort: Desc)])
  @@index([teamId, createdAt(sort: Desc)])
}

enum Role {
  ADMIN
  MEMBER
}

enum RsvpStatus {
  ATTEND
  ABSENT
  LATE
  NO_SHOW
}

enum LateFeeStatus {
  PENDING
  PAID
}

enum MatchStatus {
  DRAFT
  PENDING
  CONFIRMED
  RULES_PENDING
  RULES_CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  CHALLENGE_SENT
}

enum CancellationReason {
  INSUFFICIENT_PLAYERS
  WEATHER
  VENUE_UNAVAILABLE
  OTHER
}

enum TeamSide {
  TEAM_A
  TEAM_B
}

enum RuleTemplate {
  FUTSAL
  ELEVEN_HALVES
  CUSTOM
}

enum AssignmentStatus {
  DRAFT
  PENDING_APPROVAL
  CONFIRMED
}

enum TimerStatus {
  IDLE
  RUNNING
  PAUSED
  ENDED
}

enum FeedbackType {
  FEATURE_REQUEST
  BUG_REPORT
  IMPROVEMENT
  OTHER
}

enum FeedbackStatus {
  NEW
  IN_REVIEW
  PLANNED
  IN_PROGRESS
  COMPLETED
  REJECTED
}

enum InsightType {
  PERSONAL
  TEAM
}

enum CardType {
  YELLOW
  RED
}

model CardRecord {
  id              String        @id @default(cuid())
  trainingEventId String
  quarter         Int
  minute          Int?
  playerId        String?
  cardType        CardType      @default(YELLOW)
  teamSide        TeamSide
  recordedById    String
  createdAt       DateTime      @default(now())

  trainingEvent   TrainingEvent @relation(fields: [trainingEventId], references: [id], onDelete: Cascade)
  player          User?         @relation("CardPlayer", fields: [playerId], references: [id], onDelete: SetNull)
  recordedBy      User          @relation("CardRecorder", fields: [recordedById], references: [id])

  @@index([trainingEventId, quarter])
}
